name: CI

on:
  push:
    branches:
      - '**'
    tags:
      - '*'
  pull_request:

env:
  OCAML_COMPILER: 5.3.0

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    name: Build and test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
          - os: macos-15-intel
            arch: x64
          - os: macos-latest
            arch: arm64
          - os: windows-latest
            arch: x64

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        if: ${{ matrix.os == 'ubuntu-latest' }}
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: Use OCaml ${{ env.OCAML_COMPILER }}
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: ${{ env.OCAML_COMPILER }}
          dune-cache: true
          opam-disable-sandboxing: true

      - name: Install deps
        run: make install

      - name: Install npm deps
        run: make npm-install

      - name: Pin some deps
        run: make pin

      - name: Build
        run: make build-prod

      - name: Run tests
        run: make test

      - name: Install benchmark tools
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          wget https://github.com/sharkdp/hyperfine/releases/download/v1.18.0/hyperfine_1.18.0_amd64.deb
          sudo dpkg -i hyperfine_1.18.0_amd64.deb

      - name: Run benchmarks
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: BENCH_JQ=1 MIN_RUNS=5 ./benchmarks/bench.sh

      - name: Upload artifacts for ${{ matrix.os }}-${{ matrix.arch }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-${{ matrix.arch }}-artifact
          path: _build/default/bin/bin.exe

      - name: Upload JavaScript artifacts for NPM
        if: ${{ matrix.os == 'ubuntu-latest' }}
        uses: actions/upload-artifact@v4
        with:
          name: query-json-js
          path: _build/default/js/js.bc.js

  publish:
    if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'pull_request'
    needs: build
    name: Publish and Deploy
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: Use OCaml ${{ env.OCAML_COMPILER }}
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: ${{ env.OCAML_COMPILER }}
          dune-cache: true
          opam-disable-sandboxing: true

      - name: Install opam deps
        run: make install

      - name: Install npm deps
        run: make npm-install

      - name: Pin some deps
        run: make pin

      - name: Build
        run: make build-prod

      # Release to NPM and GitHub (only on tags)
      - name: Download JavaScript artifact
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/download-artifact@v4
        with:
          name: query-json-js
          path: _release/query-json-js

      - name: Download linux artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/download-artifact@v4
        with:
          name: ubuntu-latest-x64-artifact
          path: _release/platform-linux-x64

      - name: Download macOS x64 artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/download-artifact@v4
        with:
          name: macos-15-intel-x64-artifact
          path: _release/platform-darwin-x64

      - name: Download macOS arm64 artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/download-artifact@v4
        with:
          name: macos-latest-arm64-artifact
          path: _release/platform-darwin-arm64

      - name: Download windows artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/download-artifact@v4
        with:
          name: windows-latest-x64-artifact
          path: _release/platform-windows-x64

      - name: Allow execution of query-json
        if: startsWith(github.ref, 'refs/tags/')
        run: chmod +x _release/platform-linux-x64/bin.exe

      - name: Get version
        if: startsWith(github.ref, 'refs/tags/')
        id: version
        run: |
          VERSION=$(_release/platform-linux-x64/bin.exe --version)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Generate NPM package
        if: startsWith(github.ref, 'refs/tags/')
        run: node scripts/make-npm-release.js ${{ steps.version.outputs.version }}

      - name: Check if version exists on NPM
        if: startsWith(github.ref, 'refs/tags/')
        id: npm_check
        run: |
          if npm view @davesnx/query-json@${{ steps.version.outputs.version }} version 2>/dev/null; then
            echo "Version ${{ steps.version.outputs.version }} already exists on NPM, skipping publish"
            echo "should_publish_to_npm=false" >> "$GITHUB_OUTPUT"
          else
            echo "Version ${{ steps.version.outputs.version }} is available for publishing"
            echo "should_publish_to_npm=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create archives for Github release
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd _release/platform-darwin-x64
          mv bin.exe query-json
          zip -r ../../query-json-darwin-x64.zip .
          cd ../..

          cd _release/platform-darwin-arm64
          mv bin.exe query-json
          zip -r ../../query-json-darwin-arm64.zip .
          cd ../..

          cd _release/platform-linux-x64
          mv bin.exe query-json
          zip -r ../../query-json-linux-x64.zip .
          cd ../..

          cd _release/platform-windows-x64
          mv bin.exe query-json
          zip -r ../../query-json-windows-x64.zip .
          cd ../..

      - name: Publish to NPM
        if: startsWith(github.ref, 'refs/tags/') && steps.npm_check.outputs.should_publish_to_npm == 'true'
        run: |
          npm config set //registry.npmjs.org/:_authToken=$NODE_AUTH_TOKEN
          npm config set scope "@davesnx"
          npm publish --access public
        working-directory: ./_release
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

      - name: Create Github release
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: ncipollo/release-action@v1.16.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          makeLatest: true

      - name: Upload query-json-darwin-x64.zip to Github release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./query-json-darwin-x64.zip
          asset_name: query-json-darwin-x64.zip
          asset_content_type: application/zip

      - name: Upload query-json-darwin-arm64.zip to Github release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./query-json-darwin-arm64.zip
          asset_name: query-json-darwin-arm64.zip
          asset_content_type: application/zip

      - name: Upload query-json-linux-x64.zip to Github release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./query-json-linux-x64.zip
          asset_name: query-json-linux-x64.zip
          asset_content_type: application/zip

      - name: Upload query-json-windows-x64.zip to Github release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./query-json-windows-x64.zip
          asset_name: query-json-windows-x64.zip
          asset_content_type: application/zip

      # Publish to opam (only on tags)
      - name: Install dune-release
        if: startsWith(github.ref, 'refs/tags/')
        run: opam install dune-release -y

      - name: Create source distribution archive
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          opam exec -- dune-release distrib -p query-json
          echo "Files created:"
          ls -la *.tbz || echo "No .tbz files found in root"
          ls -la _build/*.tbz || echo "No .tbz files found in _build"

      - name: Upload source archive to Github release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: _build/query-json-${{ steps.version.outputs.version }}.tbz
          asset_name: query-json-${{ steps.version.outputs.version }}.tbz
          asset_content_type: application/x-tar

      - name: Publish to opam
        if: startsWith(github.ref, 'refs/tags/')
        uses: davesnx/dune-release-action@v0.2.1
        with:
          packages: 'query-json'
          changelog: './CHANGES.md'
          github-token: ${{ secrets.GH_TOKEN }}
          to-opam-repository: true
          to-github-releases: false

      # Deploy website (only on main or PR)
      - name: Build website
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'pull_request'
        run: make web-build

      - name: Deploy to prod
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        working-directory: ./website
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler pages deploy ../dist --project-name=query-json

      - name: Deploy preview
        if: github.event_name == 'pull_request'
        working-directory: ./website
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler pages deploy ../dist --project-name=query-json --branch=${{ github.head_ref }}
